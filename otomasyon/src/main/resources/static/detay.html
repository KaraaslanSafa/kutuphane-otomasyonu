<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Kitap Detayı</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary px-4 shadow">
    <a class="navbar-brand fw-bold" href="/index.html"><i class="fas fa-book-reader"></i> Kütüphane</a>
    <div class="ms-auto d-flex align-items-center">
        <a href="/index.html" class="btn btn-sm btn-outline-light me-2">
            <i class="fas fa-home"></i> Ana Sayfa
        </a>
        <button onclick="cikisYap()" class="btn btn-sm btn-outline-light">Çıkış</button>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <img id="kitapResim" src="" class="card-img-top" style="height: 400px; object-fit: cover;">
            </div>
            <div class="mt-3 text-center">
                <button id="favoriButon" onclick="favoriToggle()" class="btn btn-warning w-100">
                    <i class="fas fa-heart" id="favoriIcon"></i> <span id="favoriText">Favorilere Ekle</span>
                </button>
                <button id="oduncAlButon" onclick="oduncAl()" class="btn btn-primary w-100 mt-2" style="display: none;">
                    <i class="fas fa-book"></i> Ödünç Al
                </button>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 id="kitapAd" class="card-title"></h2>
                    <p class="text-muted" id="kitapYazar"></p>
                    
                    <div class="mb-3">
                        <div id="degerlendirmeYildiz" class="mb-2"></div>
                        <small class="text-muted" id="degerlendirmeBilgi"></small>
                    </div>

                    <hr>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Sayfa Sayısı:</strong> <span id="sayfaSayisi">-</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Yayın Yılı:</strong> <span id="yayinYili">-</span>
                        </div>
                        <div class="col-md-6 mt-2">
                            <strong>ISBN:</strong> <span id="isbn">-</span>
                        </div>
                        <div class="col-md-6 mt-2">
                            <strong>Durum:</strong> <span id="durum"></span>
                        </div>
                    </div>

                    <hr>

                    <h5>Açıklama</h5>
                    <p id="aciklama" class="text-muted">Açıklama bulunmamaktadır.</p>

                    <h5 class="mt-4">Özet</h5>
                    <p id="ozet" class="text-muted">Özet bulunmamaktadır.</p>
                </div>
            </div>

            <!-- Değerlendirme Bölümü -->
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-star"></i> Değerlendirmeler</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Değerlendirme Yap</label>
                        <div class="mb-2">
                            <div id="yildizSecim" class="d-flex gap-2">
                                <i class="fas fa-star text-warning" style="cursor: pointer; font-size: 24px;" onclick="yildizSec(1)"></i>
                                <i class="far fa-star text-warning" style="cursor: pointer; font-size: 24px;" onclick="yildizSec(2)"></i>
                                <i class="far fa-star text-warning" style="cursor: pointer; font-size: 24px;" onclick="yildizSec(3)"></i>
                                <i class="far fa-star text-warning" style="cursor: pointer; font-size: 24px;" onclick="yildizSec(4)"></i>
                                <i class="far fa-star text-warning" style="cursor: pointer; font-size: 24px;" onclick="yildizSec(5)"></i>
                            </div>
                        </div>
                        <textarea id="yorumMetin" class="form-control" rows="3" placeholder="Yorumunuzu yazın..."></textarea>
                        <button onclick="degerlendirmeGonder()" class="btn btn-primary mt-2">Değerlendirme Gönder</button>
                    </div>
                    <hr>
                    <div id="degerlendirmelerListesi"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dark Mode Toggle -->
<button class="theme-toggle" onclick="toggleTheme()" title="Tema Değiştir">
    <i class="fas fa-moon" id="themeIcon"></i>
</button>

<script>
    const currentUser = JSON.parse(localStorage.getItem("user"));
    const urlParams = new URLSearchParams(window.location.search);
    const kitapId = urlParams.get('id');
    let secilenYildiz = 0;
    let favoriMi = false;

    if (!currentUser) {
        window.location.href = "/login.html";
    }

    if (!kitapId) {
        window.location.href = "/index.html";
    }

    kitapDetayiniGetir();
    favoriKontrol();
    degerlendirmeleriGetir();

    function cikisYap() {
        localStorage.removeItem("user");
        window.location.href = "/login.html";
    }

    function kitapDetayiniGetir() {
        fetch(`/api/kitaplar/${kitapId}`)
            .then(res => res.json())
            .then(kitap => {
                document.getElementById("kitapAd").textContent = kitap.ad || "İsimsiz";
                document.getElementById("kitapYazar").textContent = kitap.yazar || "Yazar bilinmiyor";
                document.getElementById("kitapResim").src = kitap.resimUrl || "https://via.placeholder.com/400";
                document.getElementById("sayfaSayisi").textContent = kitap.sayfaSayisi || "-";
                document.getElementById("yayinYili").textContent = kitap.yayinYili || "-";
                document.getElementById("isbn").textContent = kitap.isbn || "-";
                
                const durum = kitap.musaitMi 
                    ? '<span class="badge bg-success">Müsait</span>' 
                    : '<span class="badge bg-warning">Ödünçte</span>';
                document.getElementById("durum").innerHTML = durum;

                if (kitap.musaitMi) {
                    document.getElementById("oduncAlButon").style.display = "block";
                }

                document.getElementById("aciklama").textContent = kitap.aciklama || "Açıklama bulunmamaktadır.";
                document.getElementById("ozet").textContent = kitap.ozet || "Özet bulunmamaktadır.";

                // Değerlendirme gösterimi
                if (kitap.degerlendirmeOrtalamasi && kitap.degerlendirmeOrtalamasi > 0) {
                    let yildizHtml = "";
                    const tamYildiz = Math.floor(kitap.degerlendirmeOrtalamasi);
                    for (let i = 1; i <= 5; i++) {
                        if (i <= tamYildiz) {
                            yildizHtml += '<i class="fas fa-star text-warning"></i>';
                        } else {
                            yildizHtml += '<i class="far fa-star text-warning"></i>';
                        }
                    }
                    document.getElementById("degerlendirmeYildiz").innerHTML = yildizHtml;
                    document.getElementById("degerlendirmeBilgi").textContent = 
                        `${kitap.degerlendirmeOrtalamasi.toFixed(1)} / 5.0 (${kitap.degerlendirmeSayisi || 0} değerlendirme)`;
                }
            });
    }

    function favoriKontrol() {
        fetch(`/api/favori/kullanici/${currentUser.id}`)
            .then(res => res.json())
            .then(favoriler => {
                favoriMi = favoriler.some(f => f.id == kitapId);
                favoriButonGuncelle();
            });
    }

    function favoriToggle() {
        if (favoriMi) {
            fetch(`/api/favori/cikar?kullaniciId=${currentUser.id}&kitapId=${kitapId}`, {method: 'DELETE'})
                .then(() => {
                    favoriMi = false;
                    favoriButonGuncelle();
                });
        } else {
            fetch(`/api/favori/ekle?kullaniciId=${currentUser.id}&kitapId=${kitapId}`, {method: 'POST'})
                .then(() => {
                    favoriMi = true;
                    favoriButonGuncelle();
                });
        }
    }

    function favoriButonGuncelle() {
        const icon = document.getElementById("favoriIcon");
        const text = document.getElementById("favoriText");
        if (favoriMi) {
            icon.className = "fas fa-heart";
            text.textContent = "Favorilerden Çıkar";
        } else {
            icon.className = "far fa-heart";
            text.textContent = "Favorilere Ekle";
        }
    }

    function oduncAl() {
        fetch(`/api/odunc/ver?kitapId=${kitapId}&kullaniciId=${currentUser.id}`, {method: 'POST'})
            .then(() => {
                alert("Kitap ödünç alındı!");
                kitapDetayiniGetir();
            });
    }

    function yildizSec(sayi) {
        secilenYildiz = sayi;
        const yildizlar = document.querySelectorAll("#yildizSecim i");
        yildizlar.forEach((yildiz, index) => {
            if (index < sayi) {
                yildiz.className = "fas fa-star text-warning";
            } else {
                yildiz.className = "far fa-star text-warning";
            }
        });
    }

    function degerlendirmeGonder() {
        if (secilenYildiz === 0) {
            alert("Lütfen yıldız seçin!");
            return;
        }
        const yorum = document.getElementById("yorumMetin").value;
        
        fetch('/api/degerlendirme/ekle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                kullaniciId: currentUser.id,
                kitapId: kitapId,
                yildiz: secilenYildiz,
                yorum: yorum
            })
        })
        .then(() => {
            alert("Değerlendirme gönderildi!");
            degerlendirmeleriGetir();
            kitapDetayiniGetir();
            document.getElementById("yorumMetin").value = "";
            secilenYildiz = 0;
            yildizSec(0);
        });
    }

    function degerlendirmeleriGetir() {
        fetch(`/api/degerlendirme/kitap/${kitapId}`)
            .then(res => res.json())
            .then(degerlendirmeler => {
                const alan = document.getElementById("degerlendirmelerListesi");
                if (degerlendirmeler.length === 0) {
                    alan.innerHTML = '<p class="text-muted">Henüz değerlendirme yok.</p>';
                } else {
                    alan.innerHTML = "";
                    degerlendirmeler.forEach(d => {
                        let yildizHtml = "";
                        for (let i = 1; i <= 5; i++) {
                            yildizHtml += i <= d.yildiz 
                                ? '<i class="fas fa-star text-warning"></i>' 
                                : '<i class="far fa-star text-warning"></i>';
                        }
                        const tarih = new Date(d.tarih).toLocaleDateString('tr-TR');
                        alan.innerHTML += `
                            <div class="border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        ${yildizHtml}
                                        <small class="text-muted ms-2">${tarih}</small>
                                    </div>
                                </div>
                                <p class="mt-2">${d.yorum || 'Yorum yok'}</p>
                            </div>
                        `;
                    });
                }
            });
    }

    // Dark Mode
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
        const icon = document.getElementById('themeIcon');
        if (icon) {
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
    });
</script>

</body>
</html>

